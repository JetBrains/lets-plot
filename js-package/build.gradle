plugins {
    id "org.jetbrains.kotlin.multiplatform"
}

kotlin {
    js() {
        browser()
        binaries.executable()
    }
    sourceSets {
        jsMain {
            dependencies {
                implementation "org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"

                implementation project(':commons')
                implementation project(':datamodel')
                implementation project(':canvas')
                implementation project(':plot-base')
                implementation project(':plot-builder')
                implementation project(':plot-stem')
                implementation project(':platf-w3c')
                implementation project(':gis')
                implementation(project(":livemap"))
                implementation project(':plot-livemap')

                implementation("io.ktor:ktor-client-websockets-js:$ktor_version")
                implementation("io.ktor:ktor-client-js:$ktor_version")
                implementation("io.github.microutils:kotlin-logging-js:$kotlinLogging_version")
            }
        }
    }
}

def dist_dir = "${project.buildDir}/distributions"
def js_publish_dir = "${rootDir}/js-package/distr"

tasks.register('renameJsArtifact') {
    group = project.letsPlotTaskGroup
    doLast{
        copy {
            from "${dist_dir}/js-package.js"
            rename "js-package.js", "lets-plot-latest.js"
            into dist_dir
        }
    }
}

jsBrowserProductionWebpack.finalizedBy renameJsArtifact

tasks.register("copyForPublish") {
    dependsOn jsBrowserProductionWebpack
    copy {
        from "${dist_dir}/js-package.js"
        rename "js-package.js", "lets-plot.js"
        into js_publish_dir
    }
}
